name: CI/CD Pipeline - Service Change Detection

on:
  push:
    branches: [master, develop]
    paths:
      - 'services/**'
      - '.github/workflows/**'
  pull_request:
    branches: [master, develop]
    paths:
      - 'services/**'

permissions:
  contents: write
  security-events: write
  actions: read

env:
  DOCKER_REGISTRY: docker.io  # Change to your ECR URL for AWS ECR
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  AWS_REGION: us-east-1
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # Job 1: Detect which services have changed
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      auth-service: ${{ steps.filter.outputs.auth-service }}
      task-service: ${{ steps.filter.outputs.task-service }}
      frontend: ${{ steps.filter.outputs.frontend }}
      nginx: ${{ steps.filter.outputs.nginx }}
      any-change: ${{ steps.filter.outputs.any-change }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for service changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth-service:
              - 'services/auth-service/**'
            task-service:
              - 'services/task-service/**'
            frontend:
              - 'services/frontend/**'
            nginx:
              - 'services/nginx/**'
            any-change:
              - 'services/**'

      - name: Display detected changes
        run: |
          echo "üîç Change Detection Results:"
          echo "Auth Service Changed: ${{ steps.filter.outputs.auth-service }}"
          echo "Task Service Changed: ${{ steps.filter.outputs.task-service }}"
          echo "Frontend Changed: ${{ steps.filter.outputs.frontend }}"
          echo "Nginx Changed: ${{ steps.filter.outputs.nginx }}"

  # Job 2: Build and push Auth Service
  build-auth-service:
    name: Build Auth Service
    needs: detect-changes
    if: needs.detect-changes.outputs.auth-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Uncomment for AWS ECR
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ${{ env.AWS_REGION }}
      #
      # - name: Login to Amazon ECR
      #   id: login-ecr
      #   uses: aws-actions/amazon-ecr-login@v2

      - name: Build Auth Service Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/auth-service
          push: false
          tags: |
            ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ env.IMAGE_TAG }}
            ${{ env.DOCKER_USERNAME }}/task-manager-auth:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Scan Auth Service image with Trivy (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-auth-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Scan Auth Service image with Trivy (JSON)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ env.IMAGE_TAG }}
          format: 'json'
          output: 'trivy-auth-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-auth-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-auth-results.sarif'
          category: 'auth-service'

      - name: Upload Trivy JSON results as artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('trivy-auth-results.json') != ''
        with:
          name: trivy-auth-results
          path: trivy-auth-results.json

      - name: Push Auth Service image
        run: |
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-auth:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-auth:latest

      - name: Save image tag for K8s update
        run: |
          mkdir -p artifacts
          echo "${{ env.IMAGE_TAG }}" > artifacts/auth-service-tag.txt
          echo "auth-service" > artifacts/auth-service-name.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: auth-service-artifacts
          path: artifacts/

  # Job 3: Build and push Task Service
  build-task-service:
    name: Build Task Service
    needs: detect-changes
    if: needs.detect-changes.outputs.task-service == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Task Service Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/task-service
          push: false
          tags: |
            ${{ env.DOCKER_USERNAME }}/task-manager-task:${{ env.IMAGE_TAG }}
            ${{ env.DOCKER_USERNAME }}/task-manager-task:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Scan Task Service image with Trivy (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-task:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-task-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Scan Task Service image with Trivy (JSON)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-task:${{ env.IMAGE_TAG }}
          format: 'json'
          output: 'trivy-task-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-task-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-task-results.sarif'
          category: 'task-service'

      - name: Upload Trivy JSON results as artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('trivy-task-results.json') != ''
        with:
          name: trivy-task-results
          path: trivy-task-results.json

      - name: Push Task Service image
        run: |
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-task:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-task:latest

      - name: Save image tag for K8s update
        run: |
          mkdir -p artifacts
          echo "${{ env.IMAGE_TAG }}" > artifacts/task-service-tag.txt
          echo "task-service" > artifacts/task-service-name.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: task-service-artifacts
          path: artifacts/

  # Job 4: Build and push Frontend
  build-frontend:
    name: Build Frontend
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/frontend
          push: false
          tags: |
            ${{ env.DOCKER_USERNAME }}/task-manager-frontend:${{ env.IMAGE_TAG }}
            ${{ env.DOCKER_USERNAME }}/task-manager-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Scan Frontend image with Trivy (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-frontend:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Scan Frontend image with Trivy (JSON)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-frontend:${{ env.IMAGE_TAG }}
          format: 'json'
          output: 'trivy-frontend-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-frontend-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-frontend-results.sarif'
          category: 'frontend'

      - name: Upload Trivy JSON results as artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('trivy-frontend-results.json') != ''
        with:
          name: trivy-frontend-results
          path: trivy-frontend-results.json

      - name: Push Frontend image
        run: |
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-frontend:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-frontend:latest

      - name: Save image tag for K8s update
        run: |
          mkdir -p artifacts
          echo "${{ env.IMAGE_TAG }}" > artifacts/frontend-tag.txt
          echo "frontend" > artifacts/frontend-name.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-artifacts
          path: artifacts/

  # Job 5: Build and push Nginx
  build-nginx:
    name: Build Nginx
    needs: detect-changes
    if: needs.detect-changes.outputs.nginx == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Nginx Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./services/nginx
          push: false
          tags: |
            ${{ env.DOCKER_USERNAME }}/task-manager-nginx:${{ env.IMAGE_TAG }}
            ${{ env.DOCKER_USERNAME }}/task-manager-nginx:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Scan Nginx image with Trivy (SARIF)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-nginx:${{ env.IMAGE_TAG }}
          format: 'sarif'
          output: 'trivy-nginx-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Scan Nginx image with Trivy (JSON)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ env.DOCKER_USERNAME }}/task-manager-nginx:${{ env.IMAGE_TAG }}
          format: 'json'
          output: 'trivy-nginx-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-nginx-results.sarif') != ''
        continue-on-error: true
        with:
          sarif_file: 'trivy-nginx-results.sarif'
          category: 'nginx'

      - name: Upload Trivy JSON results as artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('trivy-nginx-results.json') != ''
        with:
          name: trivy-nginx-results
          path: trivy-nginx-results.json

      - name: Push Nginx image
        run: |
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-nginx:${{ env.IMAGE_TAG }}
          docker push ${{ env.DOCKER_USERNAME }}/task-manager-nginx:latest

      - name: Save image tag for K8s update
        run: |
          mkdir -p artifacts
          echo "${{ env.IMAGE_TAG }}" > artifacts/nginx-tag.txt
          echo "nginx" > artifacts/nginx-name.txt

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nginx-artifacts
          path: artifacts/

  # Job 6: Collect vulnerabilities and send notifications
  vulnerability-notification:
    name: Vulnerability Notification
    needs: [detect-changes, build-auth-service, build-task-service, build-frontend, build-nginx]
    if: |
      always() && 
      needs.detect-changes.outputs.any-change == 'true' &&
      (needs.build-auth-service.result == 'success' || 
       needs.build-task-service.result == 'success' || 
       needs.build-frontend.result == 'success' || 
       needs.build-nginx.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Download all Trivy results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: trivy-results/

      - name: Parse vulnerabilities and generate report
        id: parse-vulns
        run: |
          echo "üîç Parsing Trivy scan results..."
          
          # Initialize counters
          TOTAL_CRITICAL=0
          TOTAL_HIGH=0
          TOTAL_MEDIUM=0
          
          # Create report file
          REPORT_FILE="vulnerability-report.md"
          echo "# üîí Security Vulnerability Report" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Repository:** ${{ github.repository }}" >> $REPORT_FILE
          echo "**Commit:** ${{ github.sha }}" >> $REPORT_FILE
          echo "**Branch:** ${{ github.ref_name }}" >> $REPORT_FILE
          echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          # Process each service's Trivy results
          for service_dir in trivy-results/trivy-*-results; do
            if [ -d "$service_dir" ]; then
              SERVICE_NAME=$(basename "$service_dir" | sed 's/trivy-//;s/-results//')
              JSON_FILE="$service_dir/trivy-${SERVICE_NAME}-results.json"
              
              if [ -f "$JSON_FILE" ]; then
                echo "Processing $SERVICE_NAME..."
                
                # Count vulnerabilities by severity
                CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' "$JSON_FILE" 2>/dev/null || echo 0)
                HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' "$JSON_FILE" 2>/dev/null || echo 0)
                MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' "$JSON_FILE" 2>/dev/null || echo 0)
                
                TOTAL_CRITICAL=$((TOTAL_CRITICAL + CRITICAL))
                TOTAL_HIGH=$((TOTAL_HIGH + HIGH))
                TOTAL_MEDIUM=$((TOTAL_MEDIUM + MEDIUM))
                
                # Add service section to report
                echo "## üì¶ ${SERVICE_NAME^^} Service" >> $REPORT_FILE
                echo "" >> $REPORT_FILE
                echo "| Severity | Count |" >> $REPORT_FILE
                echo "|----------|-------|" >> $REPORT_FILE
                echo "| üî¥ CRITICAL | $CRITICAL |" >> $REPORT_FILE
                echo "| üü† HIGH | $HIGH |" >> $REPORT_FILE
                echo "| üü° MEDIUM | $MEDIUM |" >> $REPORT_FILE
                echo "" >> $REPORT_FILE
                
                # List CRITICAL vulnerabilities
                if [ "$CRITICAL" -gt 0 ]; then
                  echo "### üî¥ Critical Vulnerabilities" >> $REPORT_FILE
                  echo "" >> $REPORT_FILE
                  jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL") | "- **\(.VulnerabilityID)**: \(.PkgName) (\(.InstalledVersion)) - \(.Title // "No description")"' "$JSON_FILE" 2>/dev/null >> $REPORT_FILE || true
                  echo "" >> $REPORT_FILE
                fi
                
                # List HIGH vulnerabilities
                if [ "$HIGH" -gt 0 ]; then
                  echo "### üü† High Vulnerabilities" >> $REPORT_FILE
                  echo "" >> $REPORT_FILE
                  jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH") | "- **\(.VulnerabilityID)**: \(.PkgName) (\(.InstalledVersion)) - \(.Title // "No description")"' "$JSON_FILE" 2>/dev/null >> $REPORT_FILE || true
                  echo "" >> $REPORT_FILE
                fi
                
                echo "---" >> $REPORT_FILE
                echo "" >> $REPORT_FILE
              fi
            fi
          done
          
          # Add summary
          echo "## üìä Summary" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Total Vulnerabilities Found:**" >> $REPORT_FILE
          echo "- üî¥ Critical: $TOTAL_CRITICAL" >> $REPORT_FILE
          echo "- üü† High: $TOTAL_HIGH" >> $REPORT_FILE
          echo "- üü° Medium: $TOTAL_MEDIUM" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          # Set outputs
          echo "total_critical=$TOTAL_CRITICAL" >> $GITHUB_OUTPUT
          echo "total_high=$TOTAL_HIGH" >> $GITHUB_OUTPUT
          echo "total_medium=$TOTAL_MEDIUM" >> $GITHUB_OUTPUT
          
          # Display report
          cat $REPORT_FILE
          
          echo "‚úÖ Vulnerability report generated"

      - name: Send Slack notification
        if: steps.parse-vulns.outputs.total_critical > 0 || steps.parse-vulns.outputs.total_high > 0
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "‚ö†Ô∏è  SLACK_WEBHOOK_URL secret not configured. Skipping Slack notification."
            exit 0
          fi
          
          # Determine severity color
          if [ "${{ steps.parse-vulns.outputs.total_critical }}" -gt 0 ]; then
            COLOR="danger"
            EMOJI="üî¥"
          elif [ "${{ steps.parse-vulns.outputs.total_high }}" -gt 0 ]; then
            COLOR="warning"
            EMOJI="üü†"
          else
            COLOR="good"
            EMOJI="üü°"
          fi
          
          # Create Slack message
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"attachments\": [
                {
                  \"color\": \"$COLOR\",
                  \"title\": \"$EMOJI Security Vulnerabilities Detected\",
                  \"text\": \"Security scan found vulnerabilities in *${{ github.repository }}*\",
                  \"fields\": [
                    {
                      \"title\": \"Critical\",
                      \"value\": \"${{ steps.parse-vulns.outputs.total_critical }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"High\",
                      \"value\": \"${{ steps.parse-vulns.outputs.total_high }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Medium\",
                      \"value\": \"${{ steps.parse-vulns.outputs.total_medium }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Branch\",
                      \"value\": \"${{ github.ref_name }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"Commit\",
                      \"value\": \"<${{ github.event.repository.html_url }}/commit/${{ github.sha }}|${{ github.sha }}>\",
                      \"short\": false
                    }
                  ],
                  \"footer\": \"GitHub Actions\",
                  \"footer_icon\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
                  \"ts\": $(date +%s)
                }
              ]
            }"
          
          echo "‚úÖ Slack notification sent"

      - name: Send email notification
        if: steps.parse-vulns.outputs.total_critical > 0 || steps.parse-vulns.outputs.total_high > 0
        continue-on-error: true
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.MAIL_SERVER }}
          server_port: ${{ secrets.MAIL_PORT || '587' }}
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üîí Security Alert: Vulnerabilities in ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM || secrets.MAIL_USERNAME }}
          body: file://vulnerability-report.md
          convert_markdown: true
          priority: high

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-report
          path: vulnerability-report.md

  # Job 7: Update K8s manifests with new image tags
  update-k8s-manifests:
    name: Update K8s Manifests
    needs: [detect-changes, build-auth-service, build-task-service, build-frontend, build-nginx, vulnerability-notification]
    if: |
      always() && 
      needs.detect-changes.outputs.any-change == 'true' &&
      (needs.build-auth-service.result == 'success' || needs.build-auth-service.result == 'skipped') &&
      (needs.build-task-service.result == 'success' || needs.build-task-service.result == 'skipped') &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      (needs.build-nginx.result == 'success' || needs.build-nginx.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Update K8s deployment files
        run: |
          echo "üìù Updating K8s manifests with new image tags..."
          
          # Function to update deployment file
          update_deployment() {
            local service=$1
            local deployment_file=$2
            local tag_file="artifacts/${service}-artifacts/${service}-tag.txt"
            
            if [ -f "$tag_file" ]; then
              TAG=$(cat "$tag_file")
              echo "Updating $service to tag: $TAG"
              
              # Update the image in the deployment file
              sed -i "s|image: .*/task-manager-${service}:.*|image: ${{ env.DOCKER_USERNAME }}/task-manager-${service}:${TAG}|g" "$deployment_file"
              
              echo "‚úÖ Updated $deployment_file with new image tag"
            else
              echo "‚è≠Ô∏è  Skipping $service (no changes detected)"
            fi
          }
          
          # Update each service that changed
          update_deployment "auth" "k8s/base/users-deployment.yaml"
          update_deployment "task" "k8s/base/logout-deployment.yaml"
          update_deployment "frontend" "k8s/base/frontend-deployment.yaml"
          
          # Display changes
          echo "üìã Changes made:"
          git diff k8s/

      - name: Commit and push K8s manifest changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          git add k8s/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update K8s manifests with new image tags [skip ci]
            
            - Auth Service: $(cat artifacts/auth-service-artifacts/auth-service-tag.txt 2>/dev/null || echo 'no change')
            - Task Service: $(cat artifacts/task-service-artifacts/task-service-tag.txt 2>/dev/null || echo 'no change')
            - Frontend: $(cat artifacts/frontend-artifacts/frontend-tag.txt 2>/dev/null || echo 'no change')
            - Nginx: $(cat artifacts/nginx-artifacts/nginx-tag.txt 2>/dev/null || echo 'no change')
            
            Updated by GitHub Actions"
            
            git push
            echo "‚úÖ K8s manifests updated and pushed"
          fi

  # Job 8: Create summary
  pipeline-summary:
    name: Pipeline Summary
    needs: [detect-changes, build-auth-service, build-task-service, build-frontend, build-nginx, vulnerability-notification, update-k8s-manifests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Pipeline Summary
        run: |
          echo "# üöÄ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service: ${{ needs.detect-changes.outputs.auth-service == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Task Service: ${{ needs.detect-changes.outputs.task-service == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.detect-changes.outputs.frontend == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Nginx: ${{ needs.detect-changes.outputs.nginx == 'true' && '‚úÖ Changed' || '‚è≠Ô∏è No changes' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üèóÔ∏è Build Results" >> $GITHUB_STEP_SUMMARY
          echo "- Auth Service: ${{ needs.build-auth-service.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Task Service: ${{ needs.build-task-service.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.build-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Nginx: ${{ needs.build-nginx.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ÔøΩ Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerability Check: ${{ needs.vulnerability-notification.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ÔøΩüì¶ K8s Manifest Update" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ needs.update-k8s-manifests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìã Image Tags" >> $GITHUB_STEP_SUMMARY
          echo "- Image Tag: \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Registry: \`${{ env.DOCKER_REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
